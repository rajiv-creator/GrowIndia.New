
<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>GrowIndia Jobs â€” Browse</title>
  <link rel="stylesheet" href="/app.css"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/config.js?v=1"></script>
  <script src="/components.js?v=1"></script>
</head>
<body>
  <div class="container">
    <div class="row">
      <div><h1 class="h1">Open positions</h1></div>
    </div>
    <div class="search">
      <input id="q" class="input" placeholder="Search title or location"/>
      <button id="searchBtn" class="btn">Search</button>
    </div>
    <table class="table" id="tbl">
      <thead><tr><th>Title</th><th>Company</th><th>Location</th><th>Created</th></tr></thead>
      <tbody id="tbody"></tbody>
    </table>
    <div class="pagination">
      <button class="btn" id="prev">Prev</button>
      <span id="page" class="small muted"></span>
      <button class="btn" id="next">Next</button>
    </div>
  </div>

<script>
(async()=>{
  const s = await getSession();
  header(s?.user, await isAdmin());

  let page=1, pageSize=10, q="";
  const tbody = document.getElementById("tbody");
  const bind = async ()=>{
    tbody.innerHTML = spinnerRow();
    let query = sb.from("jobs")
      .select("id,title,location,created_at,companies(name)", { count:"exact" })
      .eq("published", true)
      .order("created_at", { ascending:false })
      .range((page-1)*pageSize, page*pageSize-1);
    if(q){
      query = query.ilike("title", `%${q}%`).or(`location.ilike.%${q}%`);
    }
    const { data, error, count } = await query;
    if(error){ tbody.innerHTML = `<tr><td colspan="99">Error: ${error.message}</td></tr>`; return; }
    if(!data.length){ tbody.innerHTML = `<tr><td colspan="99" class="muted">No jobs found.</td></tr>`; }
    else{
      tbody.innerHTML = data.map(j=>`<tr>
        <td><a href="/job.html?id=${encodeURIComponent(j.id)}">${j.title}</a></td>
        <td>${j.companies?.name || "-"}</td>
        <td>${j.location || "-"}</td>
        <td>${new Date(j.created_at).toLocaleDateString()}</td>
      </tr>`).join("");
    }
    document.getElementById("page").textContent = `page ${page} of ${Math.max(1, Math.ceil((count||0)/pageSize))}`;
  };

  document.getElementById("searchBtn").onclick = ()=>{ q = document.getElementById("q").value.trim(); page=1; bind(); };
  document.getElementById("prev").onclick = ()=>{ if(page>1){page--; bind();}};
  document.getElementById("next").onclick = ()=>{ page++; bind(); };

  bind();
})();
<!-- Supabase + app scripts (order matters) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="/config.js?v=5"></script>
<script src="/components.js?v=5"></script>
</body>
</html>

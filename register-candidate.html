<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Candidate account — GrowIndia Jobs</title>
  <style>
    :root{
      --blue:#151B54; --blue-600:#0F1540; --orange:#FF6E00;
      --ink:rgba(15,23,42,.9); --bg:#F6F8FC; --card:#fff; --line:#E5E7EB; --muted:#64748B;
    }
    body{margin:0;background:var(--bg);color:var(--ink);
      font:16px/1.5 Inter,"Noto Sans",system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;}
    .container{max-width:960px;margin:0 auto;padding:20px}
    header{background:#fff;border-bottom:1px solid var(--line)}
    .nav{display:flex;align-items:center;justify-content:space-between}
    .brand{font-weight:700}
    .actions{display:flex;gap:12px}
    .chip{padding:10px 18px;border-radius:999px;font-weight:600;color:#fff;background:var(--blue)}
    .chip.orange{background:var(--orange)}
    .chip:hover{background:var(--blue-600)}
    h1{font-size:32px;margin:24px 0}
    form{
      background:#fff;border:1px solid var(--line);border-radius:14px;padding:20px;
      box-shadow:0 6px 18px rgba(2,6,23,.06)
    }
    .row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .row-1{display:grid;grid-template-columns:1fr;gap:14px}
    label{display:block;font-weight:600;margin-bottom:6px}
    input[type="text"],input[type="email"],input[type="password"]{
      width:100%;padding:14px;border:1px solid var(--line);border-radius:10px;font:inherit
    }
    input[type="file"]{font:inherit}
    .actions-line{display:flex;align-items:center;justify-content:space-between;margin-top:16px}
    button{
      padding:12px 20px;border:0;border-radius:999px;color:#fff;background:var(--blue);font-weight:700;cursor:pointer
    }
    button:hover{background:var(--blue-600)}
    .muted{color:var(--muted)}
    .toast{
      position:fixed;right:16px;bottom:16px;background:#fff;border:1px solid var(--line);
      border-radius:12px;box-shadow:0 8px 24px rgba(2,6,23,.15);padding:12px 14px;max-width:360px
    }
  </style>
</head>
<body>
  <header>
    <div class="container nav">
      <div class="brand">GrowIndia Jobs</div>
      <div class="actions">
        <a class="chip" href="/register-candidate.html">Candidate</a>
        <a class="chip orange" href="/login.html?role=employer">Employer</a>
      </div>
    </div>
  </header>

  <main class="container">
    <h1>Candidate account</h1>
    <p class="muted" style="margin-top:-6px">Create your account to continue.</p>

    <form id="form">
      <div class="row-1">
        <div>
          <label for="name">Full name</label>
          <input id="name" type="text" placeholder="e.g., Ananya Sharma" required />
        </div>
        <div>
          <label for="email">Email</label>
          <input id="email" type="email" placeholder="you@example.com" required />
        </div>
      </div>

      <div class="row">
        <div>
          <label for="pass">Password</label>
          <input id="pass" type="password" placeholder="Minimum 6 characters" required minlength="6" />
        </div>
        <div>
          <label for="pass2">Confirm password</label>
          <input id="pass2" type="password" placeholder="Re-enter password" required minlength="6" />
        </div>
      </div>

      <div class="row-1" style="margin-top:6px">
        <div>
          <label for="phone">Phone</label>
          <input id="phone" type="text" placeholder="e.g., 9876543210" />
        </div>
        <div>
          <label for="cv">Upload CV (PDF/DOC)</label>
          <input id="cv" type="file" accept=".pdf,.doc,.docx" />
        </div>
      </div>

      <div class="actions-line">
        <button id="submit" type="submit">Next</button>
        <div class="muted">Already have an account? <a href="/login.html">Sign in</a>.</div>
      </div>
      <div id="msg" class="muted" style="margin-top:10px"></div>
    </form>
  </main>

  <div id="toast" class="toast" style="display:none"></div>

  <!-- Scripts: Supabase CDN first, then your config -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/config.js"></script>

  <script>
    const sb = window.supabase; // supplied by /config.js
    const form = document.getElementById('form');
    const btn  = document.getElementById('submit');
    const msg  = document.getElementById('msg');
    const toast= document.getElementById('toast');

    function showToast(t){
      toast.textContent = t;
      toast.style.display = 'block';
      setTimeout(()=> toast.style.display='none', 3500);
    }

    function disable(on){
      btn.disabled = on;
      btn.style.opacity = on ? .7 : 1;
      btn.textContent = on ? 'Please wait…' : 'Next';
    }

    async function uploadCV(userId, file){
      if(!file) return null;
      const path = `${userId}/${Date.now()}_${file.name.replace(/\s+/g,'_')}`;
      const { error } = await sb.storage.from('cvs').upload(path, file, { upsert:false });
      if(error) throw error;
      const { data } = sb.storage.from('cvs').getPublicUrl(path);
      return data?.publicUrl || null;
    }

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      if(!sb){ showToast('Supabase client not found. Make sure /config.js is included.'); return; }

      const full_name = document.getElementById('name').value.trim();
      const email = document.getElementById('email').value.trim();
      const pass  = document.getElementById('pass').value;
      const pass2 = document.getElementById('pass2').value;
      const phone = document.getElementById('phone').value.trim();
      const cvFile= document.getElementById('cv').files[0] || null;

      if(pass !== pass2){ showToast('Passwords do not match.'); return; }

      disable(true);
      msg.textContent = '';

      try{
        // Sign up the user
        const { data, error } = await sb.auth.signUp({
          email, password: pass,
          options:{
            emailRedirectTo: `${location.origin}/post-auth.html`,
            data: { full_name, phone } // stored in auth.user_metadata
          }
        });
        if(error) throw error;

        const user = data.user || null;
        const session = data.session || null;

        // If email confirmation is required, session will be null
        if(!session || !session.user){
          msg.innerHTML = 'Account created. Please check your email to verify before signing in.';
          showToast('Verification email sent.');
          setTimeout(()=> location.href='/login.html?verify=sent', 1200);
          return;
        }

        // If we do have a session, create/update the profiles row and upload CV
        const user_id = user.id;

        // Upsert profile
        await sb.from('profiles').upsert({
          user_id,
          role: 'candidate',
          full_name,
          phone
        }, { onConflict: 'user_id' });

        // Upload CV (optional)
        if(cvFile){
          try{
            const url = await uploadCV(user_id, cvFile);
            if(url){
              await sb.from('profiles').update({ cv_url: url }).eq('user_id', user_id);
            }
          }catch(cvErr){
            console.warn('CV upload failed:', cvErr);
            showToast('Signed up, but CV upload failed. You can upload from your dashboard later.');
          }
        }

        // Done → dashboard
        location.href = '/dashboard.html';
      }catch(err){
        console.error(err);
        showToast(err.message || 'Something went wrong.');
        msg.textContent = 'Error: ' + (err.message || err);
      }finally{
        disable(false);
      }
    });
  </script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Job — GrowIndia</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/config.js?v=13"></script>
  <script src="/components.js?v=13"></script>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:#fbfcfe;color:#0f172a}
    .wrap{max-width:1000px;margin:0 auto;padding:20px 16px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;box-shadow:0 10px 28px rgba(2,6,23,.06);padding:18px}
    h1{margin:0}
    .muted{color:#64748b}
    label{display:block;margin:10px 0 6px;font-weight:600}
    input,textarea{width:100%;padding:12px;border:1px solid #cbd5e1;border-radius:10px}
    textarea{min-height:140px}
    button{margin-top:12px;padding:12px 16px;border:none;border-radius:10px;background:#0ea5e9;color:#fff;font-weight:700;cursor:pointer}
  </style>
</head>
<body>
  <main class="wrap">
    <div id="jobCard" class="card"><h1>Loading…</h1></div>

    <div class="card" style="margin-top:16px">
      <h2 style="margin:0 0 10px">Apply</h2>
      <form id="applyForm">
        <label>Full name *</label>
        <input id="name" required placeholder="Your name"/>
        <label>Email *</label>
        <input id="email" type="email" required placeholder="you@example.com"/>
        <label>Message</label>
        <textarea id="message" placeholder="Write a short note…"></textarea>
        <button id="btnApply" type="submit">Submit application</button>
      </form>
    </div>
  </main>

  <script>
  (async function(){
    const { db, escapeHTML, ui } = window.app;
    const params = new URLSearchParams(location.search);
    const id = params.get('id');

    if (!id) {
      document.getElementById('jobCard').innerHTML = '<h1>Job not found</h1>';
      return;
    }

    try {
      const j = await db.getJobByIdPublic(id);
      if (!j || (j.published === false)) {
        document.getElementById('jobCard').innerHTML = '<h1>Job not found</h1>';
        return;
      }
      document.getElementById('jobCard').innerHTML = `
        <h1>${escapeHTML(j.title)}</h1>
        <div class="muted" style="margin-top:6px">${escapeHTML(j.company?.name||'—')} • ${escapeHTML(j.location)} • ${escapeHTML(j.employment_type)}</div>
        <div style="margin-top:10px;white-space:pre-wrap;line-height:1.55">${escapeHTML(j.description||'')}</div>
        <div style="margin-top:10px;color:#0a3a5f;font-weight:700">${j.min_salary?escapeHTML(j.min_salary):''}${j.max_salary?'–'+escapeHTML(j.max_salary):''} ${escapeHTML(j.currency||'')}</div>
      `;

      // Apply handler
      document.getElementById('applyForm').addEventListener('submit', async (e)=>{
        e.preventDefault();
        const candidate_name = document.getElementById('name').value.trim();
        const email = document.getElementById('email').value.trim();
        const message = document.getElementById('message').value.trim();
        if(!candidate_name || !email) return ui.error('Name and email are required');
        try {
          await db.applyToJob({ job_id:id, candidate_name, email, message });
          ui.success('Application submitted!');
          e.target.reset();
        } catch(err){ console.error(err); ui.error('Could not submit application'); }
      });

    } catch(e){ console.error(e); document.getElementById('jobCard').innerHTML = '<h1>Failed to load job</h1>'; }
  })();
  </script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>GrowIndia Jobs — Employer</title>
  <link rel="stylesheet" href="/styles.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/config.js?v=11"></script>
  <script src="/components.js?v=11"></script>
  <style>
    .card{border:1px solid #e5e7eb;border-radius:12px;padding:16px;margin:16px 0}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .row > .col{flex:1 1 240px}
    label{display:block;font-weight:600;margin:8px 0 4px}
    input, select, textarea{width:100%;padding:10px;border:1px solid #cbd5e1;border-radius:8px}
    button{padding:10px 14px;border-radius:8px;border:none;background:#0ea5e9;color:#fff;font-weight:600;cursor:pointer}
    button[disabled]{opacity:.7;cursor:not-allowed}
    .muted{color:#64748b;font-size:14px}
    .toolbar{display:flex;justify-content:space-between;align-items:center}
    .toolbar a{color:#0ea5e9;text-decoration:none;font-weight:600}
  </style>
</head>
<body>
  <main class="container" style="max-width:960px;margin:0 auto;padding:24px">
    <div class="toolbar">
      <h1>Employer Dashboard</h1>
      <a href="/employer-apps.html">View applications inbox →</a>
    </div>

    <section class="card" id="companySection">
      <h2>Your Company</h2>
      <div class="row">
        <div class="col">
          <label for="companySelect">Select company</label>
          <select id="companySelect"></select>
          <p class="muted">Don’t see your company? Create one ↓</p>
        </div>
      </div>

      <form id="createCompanyForm" class="row" style="margin-top:8px">
        <div class="col">
          <label for="c_name">Company name</label>
          <input id="c_name" name="name" required placeholder="Acme Pvt Ltd">
        </div>
        <div class="col">
          <label for="c_site">Website (optional)</label>
          <input id="c_site" name="website" placeholder="https://…">
        </div>
        <div class="col" style="align-self:flex-end">
          <button id="btnCreateCompany" type="submit">Create company</button>
        </div>
      </form>
    </section>

    <section class="card" id="jobSection" style="display:none">
      <h2>Post a Job</h2>
      <form id="jobForm">
        <div class="row">
          <div class="col">
            <label for="j_title">Title *</label>
            <input id="j_title" name="title" required placeholder="Software Engineer">
          </div>
          <div class="col">
            <label for="j_location">Location *</label>
            <input id="j_location" name="location" required placeholder="Remote / Mumbai">
          </div>
          <div class="col">
            <label for="j_type">Employment Type *</label>
            <select id="j_type" name="employment_type" required>
              <option value="">Select…</option>
              <option value="full-time">full-time</option>
              <option value="part-time">part-time</option>
              <option value="contract">contract</option>
              <option value="internship">internship</option>
              <option value="temporary">temporary</option>
              <option value="freelance">freelance</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label for="j_min">Min Salary</label>
            <input id="j_min" name="min_salary" type="number" min="0" step="1" placeholder="e.g., 600000">
          </div>
          <div class="col">
            <label for="j_max">Max Salary</label>
            <input id="j_max" name="max_salary" type="number" min="0" step="1" placeholder="e.g., 1200000">
          </div>
          <div class="col">
            <label for="j_curr">Currency</label>
            <input id="j_curr" name="currency" value="INR">
          </div>
        </div>

        <div class="row">
          <div class="col" style="flex:1 1 100%">
            <label for="j_desc">Description</label>
            <textarea id="j_desc" name="description" rows="6" placeholder="Role, responsibilities, requirements…"></textarea>
          </div>
        </div>

        <div class="row" style="align-items:center">
          <div class="col">
            <label><input type="checkbox" id="j_pub" name="published"> Publish immediately</label>
          </div>
          <div class="col" style="align-self:flex-end">
            <button id="btnPostJob" type="submit">Post job</button>
          </div>
        </div>
      </form>
    </section>
  </main>

  <script>
    (async function(){
      const { ui, q, requireAuth } = window.app;
      let user; try { user = await requireAuth(); } catch { return; }

      async function refreshCompanies(selectId=null){
        const companies = await window.app.db.myCompanies(user.id);
        const sel = q('#companySelect'); sel.innerHTML='';
        if (companies.length === 0) {
          sel.innerHTML = '<option value="">— No companies yet —</option>';
          q('#jobSection').style.display='none';
        } else {
          sel.innerHTML = companies.map(c=>`<option value="${c.id}">${window.app.escapeHTML(c.name)}</option>`).join('');
          if (selectId) sel.value = selectId;
          q('#jobSection').style.display='block';
        }
      }
      await refreshCompanies();

      q('#createCompanyForm').addEventListener('submit', async (e)=>{
        e.preventDefault();
        const btn = q('#btnCreateCompany'); window.app.ui.setLoading(btn,true);
        try {
          const { name, website } = window.app.serializeForm(e.target);
          if (!name?.trim()) return ui.error('Company name is required');
          const created = await window.app.db.createCompany({ name, website, owner_id: user.id });
          ui.success('Company created'); e.target.reset();
          await refreshCompanies(created.id);
        } catch(err){ ui.error(err.message||'Failed to create company'); console.error(err); }
        finally { window.app.ui.setLoading(btn,false); }
      });

      q('#jobForm').addEventListener('submit', async (e)=>{
        e.preventDefault();
        const btn = q('#btnPostJob'); window.app.ui.setLoading(btn,true);
        try {
          const company_id = q('#companySelect').value;
          if (!company_id) return ui.error('Select or create a company first');

          const f = window.app.serializeForm(e.target);
          if (!f.title?.trim()) return ui.error('Job title is required');
          if (!f.location?.trim()) return ui.error('Location is required');
          if (!f.employment_type) return ui.error('Employment type is required');

          const min = f.min_salary ? Number(f.min_salary) : null;
          const max = f.max_salary ? Number(f.max_salary) : null;
          if (min!==null && (!Number.isFinite(min)||min<0)) return ui.error('Min salary must be a non-negative number');
          if (max!==null && (!Number.isFinite(max)||max<0)) return ui.error('Max salary must be a non-negative number');
          if (min!==null && max!==null && min>max) return ui.error('Min salary cannot exceed max salary');

          await window.app.db.createJob({ ...f, company_id });
          ui.success(f.published ? 'Job posted & published' : 'Job posted (draft)');
          e.target.reset(); document.getElementById('j_curr').value='INR';
        } catch(err){ ui.error(err.message||'Failed to post job'); console.error(err); }
        finally { window.app.ui.setLoading(btn,false); }
      });
    })();
  </script>
</body>
</html>

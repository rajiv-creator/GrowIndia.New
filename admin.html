<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GrowIndia Jobs — Admin</title>
  <link rel="stylesheet" href="/app.css" />
</head>
<body>
  <main class="container" style="max-width:1100px;margin:32px auto;">
    <div id="adminBanner" class="note warn" style="display:none;margin-bottom:16px;">
      You are not an admin.
    </div>

    <section class="card">
      <h2>Companies</h2>
      <div class="table-wrap">
        <table class="table">
          <thead>
            <tr><th>Name</th><th>Owner</th><th>Website</th><th>Created</th></tr>
          </thead>
          <tbody id="companiesBody"><tr><td colspan="4">Loading…</td></tr></tbody>
        </table>
      </div>
    </section>

    <section class="card" style="margin-top:24px;">
      <h2>Jobs</h2>
      <div class="table-wrap">
        <table class="table">
          <thead>
            <tr><th>Title</th><th>Company</th><th>Published</th><th>Created</th></tr>
          </thead>
          <tbody id="jobsBody"><tr><td colspan="4">Loading…</td></tr></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- JS (order matters!) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/config.js?v=5"></script>
  <script src="/components.js?v=5"></script>

  <script>
    (async () => {
      const session = await GI.requireAuth();
      if (!session) return;

      const admin = await GI.isAdmin();
      if (!admin) {
        document.getElementById("adminBanner").style.display = "block";
        // You can still show the user's own data if you want. We'll just stop here.
        return;
      }

      // ---- Companies (admins can read all if your RLS policies from the SQL are in place)
      {
        const { data, error } = await sb
          .from("companies")
          .select("id,name,website,owner_id,created_at")
          .order("created_at", { ascending: false });

        const tbody = document.getElementById("companiesBody");
        if (error) {
          tbody.innerHTML = `<tr><td colspan="4">Load error: ${error.message}</td></tr>`;
        } else if (!data || !data.length) {
          tbody.innerHTML = `<tr><td colspan="4">No companies yet.</td></tr>`;
        } else {
          tbody.innerHTML = data.map(r => `
            <tr>
              <td>${r.name ?? ""}</td>
              <td style="font-family:ui-monospace,monospace">${r.owner_id ?? ""}</td>
              <td>${r.website ?? ""}</td>
              <td>${new Date(r.created_at).toLocaleString()}</td>
            </tr>
          `).join("");
        }
      }

      // ---- Jobs
      {
        // If you defined a FK relationship in Supabase, you can use: select("title,published,created_at,companies(name)")
        // Otherwise we just show company_id.
        const { data, error } = await sb
          .from("jobs")
          .select("id,title,published,company_id,created_at")
          .order("created_at", { ascending: false });

        const tbody = document.getElementById("jobsBody");
        if (error) {
          tbody.innerHTML = `<tr><td colspan="4">Load error: ${error.message}</td></tr>`;
        } else if (!data || !data.length) {
          tbody.innerHTML = `<tr><td colspan="4">No jobs yet.</td></tr>`;
        } else {
          tbody.innerHTML = data.map(r => `
            <tr>
              <td>${r.title ?? ""}</td>
              <td style="font-family:ui-monospace,monospace">${r.company_id ?? ""}</td>
              <td>${r.published ? "Yes" : "No"}</td>
              <td>${new Date(r.created_at).toLocaleString()}</td>
            </tr>
          `).join("");
        }
      }
    })();
  </script>
</body>
</html>
